!function(r,i){function t(e){i.BaseGateway.call(this,e),i.CheckoutGateway.call(this),r(document.body).on("click","#place_order",this.place_order.bind(this)),this.is_current_page("order_pay")&&r("#order_review").on("submit",this.process_order_pay.bind(this)),this.maybe_hide_gateway()}function e(e){this.elementType="idealBank",this.confirmation_method="confirmIdealPayment",t.call(this,e),window.addEventListener("hashchange",this.hashChange.bind(this))}function s(e){this.elementType="p24Bank",this.confirmation_method="confirmP24Payment",t.call(this,e),window.addEventListener("hashchange",this.hashChange.bind(this))}function n(e){this.elementType="iban",t.call(this,e)}function a(e){t.call(this,e),r(document.body).on("change",".wc-stripe-klarna-category",this.category_change.bind(this)),r("form.checkout").on("change",".form-row:not(.address-field):not(#account_password_field) .input-text, .form-row:not(.address-field) select",this.input_change.bind(this))}function o(e){this.elementType="fpxBank",this.confirmation_method="confirmFpxPayment",t.call(this,e),window.addEventListener("hashchange",this.hashChange.bind(this))}function h(e){t.call(this,e),window.addEventListener("hashchange",this.hashChange.bind(this))}function c(e){this.elementType="auBankAccount",this.confirmation_method="confirmAuBecsDebitPayment",t.call(this,e),window.addEventListener("hashchange",this.hashChange.bind(this))}function p(e){this.confirmation_method="confirmGrabPayPayment",t.call(this,e),window.addEventListener("hashchange",this.hashChange.bind(this))}function l(e){this.confirmation_method="confirmAfterpayClearpayPayment",t.call(this,e),window.addEventListener("hashchange",this.hashChange.bind(this))}(t.prototype=r.extend({},i.BaseGateway.prototype,i.CheckoutGateway.prototype)).initialize=function(){this.mount_button()},t.prototype.elementType=null,t.prototype.is_active=function(){return r("#wc_stripe_local_payment_"+this.gateway_id).data("active")},t.prototype.maybe_hide_gateway=function(){this.is_active()?r(this.container).show():r(this.container).hide()},t.prototype.createSource=function(){return new Promise(function(t,e){var i=function(e){e.error?this.submit_error(e.error):(this.payment_token_received=!0,this.set_nonce(e.source.id),this.get_form().submit()),t()}.bind(this);if(null!=this.elementType)if(this.confirmation_method)if(this.confirmation_obj)this.processConfirmation(this.confirmation_obj);else{if(!this.isValidElement())return this.submit_error({code:"empty_element_"+this.params.local_payment_type,message:wc_stripe_messages.empty_element});this.payment_token_received=!0,this.get_form().submit()}else this.stripe.createSource(this.element,this.getSourceArgs()).then(i)["catch"](function(e){this.submit_error(e.message)}.bind(this));else this.payment_token_received=!0,this.get_form().submit()}.bind(this))},t.prototype.place_order=function(e){this.is_gateway_selected()&&(this.payment_token_received||this.is_saved_method_selected()||(e.preventDefault(),this.createSource()))},t.prototype.process_order_pay=function(e){var t;this.is_gateway_selected()&&(e.preventDefault(),(t=this.get_form().serializeArray()).push({name:"_wpnonce",value:this.params.rest_nonce}),t.push({name:"order_id",value:this.params.order_id}),e=window.location.search,this.params.routes.order_pay.match(/\?/)&&(e="&"+e.substr(1)),r.ajax({url:this.params.routes.order_pay+e,method:"POST",dataType:"json",data:r.param(t)}).done(function(e){e.success?window.location.href=e.redirect:this.submit_error(e.message)}.bind(this)).fail(function(e,t,i){this.submit_error(i)}.bind(this)))},t.prototype.show_payment_button=function(){this.show_place_order()},t.prototype.hide_place_order=function(){},t.prototype.show_place_order=function(){i.CheckoutGateway.prototype.show_place_order.apply(this,arguments),this.payment_token_received&&r("#place_order").text(r("#place_order").data("value"))},t.prototype.getSourceArgs=function(){return{type:this.params.local_payment_type,amount:this.get_total_price_cents(),currency:this.get_currency(),owner:{name:this.get_customer_name("billing"),email:this.fields.get("billing_email",null)},redirect:{return_url:this.params.return_url}}},t.prototype.updated_checkout=function(){this.mount_button(),this.maybe_hide_gateway()},t.prototype.mount_button=function(){var e="#wc_stripe_local_payment_"+this.gateway_id;r(e).length&&null!=this.elementType&&(r(e).empty(),this.element||(this.element=this.elements.create(this.elementType,this.params.element_params),this.element.on("change",this.handleElementChange.bind(this))),this.elementEmpty=!0,this.element.mount(e))},t.prototype.handleElementChange=function(e){this.elementEmpty=e.empty},t.prototype.load_external_script=function(e){var t=document.createElement("script");t.type="text/javascript",t.src=e,t.onload=function(){this.script_loaded=!0}.bind(this),document.body.appendChild(t)},t.prototype.hashChange=function(e){!this.is_gateway_selected()||(e=e.newURL.match(/response=(.*)/))&&(history.pushState({},"",window.location.pathname),e=JSON.parse(window.atob(decodeURIComponent(e[1]))),this.processConfirmation(e))},t.prototype.processConfirmation=function(t){this.stripe[this.confirmation_method](t.client_secret,this.get_confirmation_args(t)).then(function(e){if(e.error)return this.confirmation_obj=t,this.payment_token_received=!1,this.submit_error(e.error.message);window.location.href=decodeURI(t.order_received_url)}.bind(this))},t.prototype.get_confirmation_args=function(e){e={payment_method:{billing_details:this.get_billing_details()},return_url:e.return_url};return this.elementType&&(e.payment_method[this.params.local_payment_type]=this.element),e},t.prototype.isValidElement=function(){return!this.element||!this.elementEmpty},t.prototype.delete_order_source=function(){return new Promise(function(t,e){r.ajax({url:this.params.routes.delete_order_source,method:"DELETE",dataType:"json",beforeSend:this.ajax_before_send.bind(this)}).done(function(e){t(e)}.bind(this)).fail(function(){e()}.bind(this))}.bind(this))},t.prototype.update_source=function(i){return new Promise(function(t,e){this.updateSourceXhr&&this.updateSourceXhr.abort(),this.updateSourceXhr=r.ajax({url:this.params.routes.update_source,method:"POST",dataType:"json",data:{_wpnonce:this.params.rest_nonce,updates:i,source_id:this.source.id,client_secret:this.source.client_secret,payment_method:this.gateway_id}}).done(function(e){t(e.source)}.bind(this)).fail(function(){e()})}.bind(this))},a.prototype.disable_place_order=function(){r("#place_order").prop("disabled",!0)},a.prototype.enable_place_order=function(){r("#place_order").prop("disabled",!1)},a.prototype.category_change=function(e){var t=function(){r('[id^="klarna-instance-"]').slideUp();var e=r('[name="klarna_category"]:checked').val();r("#klarna-instance-"+e).slideDown()}.bind(this);e.originalEvent?t():(clearTimeout(this.categoryChangeTimer),this.categoryChangeTimer=setTimeout(t,500))},a.prototype.processConfirmation=function(e){window.Klarna.Payments.init({client_token:e.klarna.client_token},function(e){}.bind(this)),this.payment_categories=e.klarna.payment_method_categories.split(","),this.render_ui(!0).then(function(){this.enable_place_order()}.bind(this))},a.prototype.hashchange=function(){this.is_gateway_selected()&&(history.pushState({},"",window.location.pathname),this.get_form().removeClass("processing"),this.get_form().submit())},a.prototype.render_ui=function(o){return new Promise(function(e){if(0<this.payment_categories.length){r("#place_order").prop("disabled",!0);var t=[];r("#wc_stripe_local_payment_stripe_klarna").show();for(var i=0;i<this.payment_categories.length;i++){var s,n="#klarna-instance-"+this.payment_categories[i];if(r(n).empty(),r("#klarna-category-"+this.payment_categories[i]).length){this.params.translate&&(s=this.source.klarna[this.payment_categories[i]+"_name"],r('label[for="klarna_'+this.payment_categories[i]+'"').text(s)),r("#klarna-category-"+this.payment_categories[i]).show();try{t.push(new Promise(function(t){window.Klarna.Payments.load({container:n,payment_method_category:this.payment_categories[i],instance_id:"klarna-instance-"+this.payment_categories[i]},function(e){e.show_form||(this.source=null),t()}.bind(this))}.bind(this)))}catch(a){window.alert(a),e()}}}Promise.all(t).then(function(){e()}),o&&r('[id^="klarna-category-"]:visible [name="klarna_category"]').first().prop("checked",!0).trigger("change")}else e()}.bind(this))},a.prototype.place_order=function(e){this.is_gateway_selected()&&(e.preventDefault(),this.checkout_fields_valid()&&window.Klarna.Payments.authorize({instance_id:"klarna-instance-"+r('[name="klarna_category"]:checked').val()},function(e){e.approved?(this.set_nonce(this.source.id),this.payment_token_received=!0,this.get_form().submit()):e.error?this.submit_error(e.error):this.submit_error(this.params.messages.klarna_error)}.bind(this)))},a.prototype.klarna_fields_valid=function(){if(this.fields.validateFields("billing"))return!this.needs_shipping()||(!!("billing"===this.get_shipping_prefix()||"shipping"===this.get_shipping_prefix()&&this.fields.validateFields("shipping"))||void 0)},a.prototype.initialize=function(){this.is_gateway_selected()&&this.is_active()&&!this.source&&this.klarna_fields_valid()&&this.createSource()},a.prototype.createSource=function(){this.sourceCreated||(this.sourceCreated=!0,this.show_loader(),this.disable_place_order(),this.stripe.createSource(this.getSourceArgs()).then(function(e){if(this.hide_loader(),e.error)return this.submit_error(e.error.message);this.source=e.source,this.set_nonce(this.source.id),this.filter_payment_method_categories(),this.processConfirmation(this.source)}.bind(this))["catch"](function(e){this.sourceCreated=!1,this.enable_place_order(),this.hide_loader(),this.submit_error(e.message)}.bind(this)))},a.prototype.getSourceArgs=function(){return r.extend(!0,{},this.get_gateway_data().source_args,function(){var e,t={owner:{name:this.fields.get("billing_first_name")+" "+this.fields.get("billing_last_name"),email:this.fields.get("billing_email"),address:{city:this.fields.get("billing_city"),country:this.fields.get("billing_country"),line1:this.fields.get("billing_address_1"),line2:this.fields.get("billing_address_2"),postal_code:this.fields.get("billing_postcode"),state:this.fields.get("billing_state")}},klarna:{purchase_country:this.fields.get("billing_country"),first_name:this.fields.get("billing_first_name"),last_name:this.fields.get("billing_last_name")}};return this.needs_shipping()&&(e=this.get_shipping_prefix(),t.klarna.shipping_first_name=this.fields.get("first_name",e),t.klarna.shipping_last_name=this.fields.get("last_name",e),t.source_order={shipping:{address:{city:this.fields.get("city",e),country:this.fields.get("country",e),line1:this.fields.get("address_1",e),line2:this.fields.get("address_2",e),postal_code:this.fields.get("postcode",e),state:this.fields.get("state",e)}}}),t}.bind(this)())},a.prototype.updated_checkout=function(){t.prototype.updated_checkout.apply(this,arguments),this.source&&this.is_active()?this.update_source():this.is_gateway_selected()&&this.is_active()&&this.klarna_fields_valid()&&this.createSource()},a.prototype.update_source=function(){var e=this.get_source_update_args(this.getSourceArgs());this.show_loader(),this.disable_place_order(),t.prototype.update_source.call(this,e).then(function(e){this.source=e,this.filter_payment_method_categories(),this.hide_loader(),this.render_ui().then(this.enable_place_order.bind(this))}.bind(this))["catch"](this.enable_place_order.bind(this))},a.prototype.checkout_error=function(){t.prototype.checkout_error.apply(this,arguments),this.is_gateway_selected()&&this.createSource()},a.prototype.show_loader=function(){r(this.container).find(".wc-stripe-klarna-loader").remove(),r(this.container).find('label[for="payment_method_'+this.gateway_id+'" ]').after(this.params.klarna_loader)},a.prototype.hide_loader=function(){r(this.container).find(".wc-stripe-klarna-loader").remove()},a.prototype.filter_payment_method_categories=function(){var e=this.source.klarna.payment_method_categories.split(",");this.source.klarna.payment_method_categories=e.filter(function(e){return-1<this.get_gateway_data().payment_sections.indexOf(e)}.bind(this)).join(",")},a.prototype.get_source_update_args=function(e){return["type","currency","statement_descriptor","redirect","klarna.product","klarna.locale","klarna.custom_payment_methods"].reduce(function(e,t){if(-1<t.indexOf(".")){var i=t.split(".");return delete i.slice(0,i.length-1).reduce(function(e,t){return e[t]},e)[t=i[i.length-1]],e}return delete e[t],e},e)},a.prototype.on_payment_method_selected=function(e,t){t===this.gateway_id&&(this.source||(this.klarna_fields_valid()?this.createSource():this.submit_error(this.params.messages.required_field)),i.CheckoutGateway.prototype.on_payment_method_selected.apply(this,arguments))},a.prototype.input_change=function(){this.is_gateway_selected()&&(this.source?this.update_source():this.klarna_fields_valid()&&this.createSource())},h.prototype.updated_checkout=function(){!this.script_loaded&&r(this.container).length&&this.load_external_script(this.params.qr_script),t.prototype.updated_checkout.apply(this,arguments)},h.prototype.hashChange=function(e){!this.is_gateway_selected()||(e=e.newURL.match(/qrcode=(.*)/))&&(history.pushState({},"",window.location.pathname),this.qrcode=JSON.parse(window.atob(decodeURIComponent(e[1]))),this.get_form().unblock().removeClass("processing").addClass("wechat"),new QRCode("wc_stripe_local_payment_stripe_wechat",{text:this.qrcode.code,width:128,height:128,colorDark:"#424770",colorLight:"#f8fbfd",correctLevel:QRCode.CorrectLevel.H}),r("#wc_stripe_local_payment_stripe_wechat").append('<p class="qrcode-message">'+this.params.qr_message+"</p>"),this.payment_token_received=!0,this.show_place_order())},h.prototype.place_order=function(){this.get_form().is(".wechat")?window.location=this.qrcode.redirect:t.prototype.place_order.apply(this,arguments)},n.prototype.getSourceArgs=function(){var e=r.extend({},t.prototype.getSourceArgs.apply(this,arguments),{mandate:{notification_method:"email",interval:this.cart_contains_subscription()||this.is_change_payment_method()?"scheduled":"one_time"}});return"scheduled"===e.mandate.interval&&delete e.amount,e},l.prototype.updated_checkout=function(){this.maybe_hide_gateway(),this.add_eligibility(this.container,parseFloat(this.get_total_price())),this.msgElement&&r(this.container).length&&(this.elements=this.stripe.elements(this.get_element_options()),this.initialize_messaging())},l.prototype.initialize=function(){this.add_eligibility(this.container,parseFloat(this.get_total_price())),this.initialize_messaging()},l.prototype.initialize_messaging=function(){this.msgElement=this.elements.create("afterpayClearpayMessage",r.extend({},this.params.msg_options,{amount:this.get_total_price_cents(),currency:this.get_currency()})),this.mount_message()},l.prototype.mount_message=function(e){e&&this.msgElement.update({amount:this.get_total_price_cents(),currency:this.get_currency()}),r('label[for="payment_method_stripe_afterpay"]').find("#wc-stripe-afterpay-msg").length||r('label[for="payment_method_stripe_afterpay"]').append('<div id="wc-stripe-afterpay-msg"></div>'),this.msgElement.mount("#wc-stripe-afterpay-msg")},l.prototype.get_element_options=function(){var e=this.params.locale;return"GB"==this.fields.get("billing_country")&&["fr-FR","it-IT","es-ES"].indexOf(e)<0?e="en-GB":this.params.supported_locales.indexOf(this.params.locale)<0&&(e="auto"),{locale:e}},l.prototype.add_eligibility=function(e,t){i.Afterpay.prototype.add_eligibility.apply(this,arguments),this.is_eligible(t)||r(this.container).find(".wc-stripe-afterpay__offsite").addClass("afterpay-ineligible")},e.prototype=r.extend({},t.prototype,e.prototype),s.prototype=r.extend({},t.prototype,s.prototype),n.prototype=r.extend({},t.prototype,n.prototype),a.prototype=r.extend({},t.prototype,a.prototype),o.prototype=r.extend({},t.prototype,o.prototype),h.prototype=r.extend({},t.prototype,h.prototype),c.prototype=r.extend({},t.prototype,c.prototype),p.prototype=r.extend({},t.prototype,p.prototype),l.prototype=r.extend({},t.prototype,i.Afterpay.prototype,l.prototype);var d,_={ideal:e,p24:s,sepa_debit:n,klarna:a,fpx:o,wechat:h,au_becs_debit:c,grabpay:p,afterpay_clearpay:l};for(d in wc_stripe_local_payment_params.gateways){var u=wc_stripe_local_payment_params.gateways[d];new(_[u.local_payment_type]||t)(u)}}(jQuery,window.wc_stripe);